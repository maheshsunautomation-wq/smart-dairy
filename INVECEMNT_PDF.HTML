<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Investment PDF Download</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      background-color: #add8e6; /* Light Blue */
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: Arial, sans-serif;
      color: #000;
    }
    .loading {
      font-size: 24px;
    }
  </style>
</head>
<body>
  <div class="loading">Generating PDF, please wait...</div>

<script>
async function generatePDF() {
  const { jsPDF } = window.jspdf;
  // Your deployed script URL
  const url = "https://script.google.com/macros/s/AKfycbyDBy8ggV3F7G3PYsxTtP5ZzRhGbCGMpi3UdYqegPT_o7M5Y32riWOnW0ZTJGlIwFfmSg/exec?action=get";

  try {
    const response = await fetch(url);
    const data = await response.json();

    // Headers for PDF
    const headers = ["DATE","FEED","WATER","ELECTRICITY","MEDICINE","DOCTOR FEES","MAINTENANCE","INCOME STREAM","TOTAL AMOUNT"];

    const rows = data.map(r => {
      const feed = Number(r.feed || 0);
      const water = Number(r.water || 0);
      const electricity = Number(r.electric || 0);
      const medicine = Number(r.medicine || 0);
      const doctor = Number(r.doctor || 0);
      const maintenance = Number(r.maintenance || 0);
      const incomeStream = r.incomeStream || "";
      const total = Number(r.totalAmount || 0);

      // Convert date string to proper IST format if needed
      const date = new Date(r.dateTime);

      return [
        UtilitiesFormatDate(date), // formatted date
        feed,
        water,
        electricity,
        medicine,
        doctor,
        maintenance,
        incomeStream,
        total
      ];
    });

    const doc = new jsPDF("landscape");
    doc.text("Investment Expense Report", 14, 15);

    doc.autoTable({
      head: [headers],
      body: rows,
      startY: 20,
      theme: "grid",
      styles: { fontSize: 10 }
    });

    // Automatically download the PDF
    doc.save("Investment_Report.pdf");

    // Optional: close the page after download
    setTimeout(() => window.close(), 500);

  } catch(err) {
    alert("Error fetching data!");
    console.error(err);
  }
}

// Helper to format date
function UtilitiesFormatDate(date){
  if(!date || isNaN(date.getTime())) return "";
  const d = date;
  const yyyy = d.getFullYear();
  const mm = ('0'+(d.getMonth()+1)).slice(-2);
  const dd = ('0'+d.getDate()).slice(-2);
  const hh = ('0'+d.getHours()).slice(-2);
  const min = ('0'+d.getMinutes()).slice(-2);
  return `${yyyy}-${mm}-${dd} ${hh}:${min}`;
}

// Trigger PDF generation as soon as the page loads
window.addEventListener("load", generatePDF);
</script>
</body>
</html>
